name: Old Publish

on:
  workflow_call:
    inputs:
      build_configuration:
        description: 'Build configuration'
        required: false
        type: string
        default: 'Release'
    secrets:
      NUGET_API_KEY:
        required: false

env:
  BRANCH_NAME: ${{ github.event.release.target_commitish }}
  SOLUTION_NAME: ${{ vars.SOLUTION_NAME }}
  DOTNET_VERSION: '9.0.x'
  NUGET_SOURCE: 'https://api.nuget.org/v3/index.json'
  BUILD_CONFIGURATION: ''

jobs:
  build-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Ensure Nerdbank.GitVersioning tool is installed
      run: |
        if ! dotnet tool list -g | grep -q nbgv; then
          dotnet tool install --global nbgv
        else
          dotnet tool update --global nbgv
        fi

    - name: Get version from Nerdbank.GitVersioning
      id: nbgv
      run: |
        nbgv get-version --format json > nbgv.json
        version=$(jq -r .NuGetPackageVersion nbgv.json)
        echo "version_tag=$version" >> $GITHUB_ENV

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity normal

    - name: Pack
      run: dotnet pack --no-build --configuration Release -p:PackageVersion=${{ env.version_tag }} -o ./output

    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./output/*.nupkg
