name: Test

on:
  workflow_call:
    inputs:
      branch:
        description: "Branch to test"
        type: string
        required: true
      solution_name:
        description: "Solution file to build and test (.slnx)"
        required: true
        type: string

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - tfm: net8.0
            sdk: 8.0.x
          - tfm: net9.0
            sdk: 9.0.x
          - tfm: net10.0
            sdk: 10.0.x

    env:
      SOLUTION_NAME: ${{ inputs.solution_name }}
      BRANCH_NAME: ${{ inputs.branch }}

    steps:
      - name: Set Build Configuration (Release if main)
        shell: bash
        run: |
          set -euo pipefail
          b="${{ env.BRANCH_NAME }}"
          if [[ "$b" == "main" || "$b" == "refs/heads/main" || "$b" == */main ]]; then
            echo "BUILD_CONFIGURATION=Release" >> $GITHUB_ENV
          else
            echo "BUILD_CONFIGURATION=Debug" >> $GITHUB_ENV
          fi

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Setup .NET SDKs (10 + matrix)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            10.0.x
            ${{ matrix.sdk }}

      - name: Validate solution exists
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -f "${{ env.SOLUTION_NAME }}" ]]; then
            echo "❌ Solution not found: ${{ env.SOLUTION_NAME }}"
            echo "Repo root contents:"; ls -la
            exit 1
          fi

      - name: Restore (once)
        run: dotnet restore "${{ env.SOLUTION_NAME }}"

      - name: Run solution test projects for ${{ matrix.tfm }} in brand ${{inputs.branch}}
        shell: bash
        run: |
          set -euo pipefail
      
          sln="${{ env.SOLUTION_NAME }}"
          tfm="${{ matrix.tfm }}"
          mkdir -p "TestResults/$tfm"
      
          # Get only test projects from the solution (must live in test/)
          mapfile -t test_projects < <(
            dotnet sln "$sln" list \
              | sed '1,2d' \
              | sed '/^\s*$/d' \
              | grep -E '^(test[\\/]).*\.csproj$' \
              || true
          )
      
          if [[ "${#test_projects[@]}" -eq 0 ]]; then
            echo "❌ No test projects found in solution under test/."
            exit 1
          fi
      
          ran_any=false
          for proj in "${test_projects[@]}"; do
            frameworks=$(grep -oPm1 "(?<=<TargetFrameworks>)[^<]+" "$proj" || true)
            if [[ -z "$frameworks" ]]; then
              frameworks=$(grep -oPm1 "(?<=<TargetFramework>)[^<]+" "$proj" || true)
            fi
      
            if ! echo "$frameworks" | tr ';' '\n' | grep -qx "$tfm"; then
              continue
            fi
      
            ran_any=true
            name="$(basename "$proj" .csproj)"
      
            dotnet test "$proj" \
              --no-restore \
              --configuration "$BUILD_CONFIGURATION" \
              --framework "$tfm" \
              --logger "trx;LogFileName=${name}-${tfm}.trx" \
              --results-directory "TestResults/$tfm"
          done
      
          if [[ "$ran_any" == "false" ]]; then
            echo "⚠️ No solution test projects under test/ target $tfm."
            echo "No $tfm test results" > "TestResults/$tfm/placeholder.txt"
            exit 1
          fi
      
                ran_any=false
      
                for proj in "${test_projects[@]}"; do
                  # Determine TargetFrameworks
                  frameworks=$(grep -oPm1 "(?<=<TargetFrameworks>)[^<]+" "$proj" || true)
                  if [[ -z "$frameworks" ]]; then
                    frameworks=$(grep -oPm1 "(?<=<TargetFramework>)[^<]+" "$proj" || true)
                  fi
      
                  if ! echo "$frameworks" | tr ';' '\n' | grep -qx "$tfm"; then
                    continue
                  fi
      
                  ran_any=true
                  name="$(basename "$proj" .csproj)"
      
                  dotnet test "$proj" \
                    --no-restore \
                    --configuration "$BUILD_CONFIGURATION" \
                    --framework "$tfm" \
                    --logger "trx;LogFileName=${name}-${tfm}.trx" \
                    --results-directory "TestResults/$tfm"
                done
      
                if [[ "$ran_any" == "false" ]]; then
                  echo "⚠️ No solution test projects target $tfm."
                  echo "No $tfm test results (no solution test projects target $tfm)" > "TestResults/$tfm/placeholder.txt"
                  exit 1
                fi
      
            - name: Upload ${{ matrix.tfm }} Test Results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                name: test-results-${{ matrix.tfm }}
                path: |
                  TestResults/${{ matrix.tfm }}/*.trx
                  TestResults/${{ matrix.tfm }}/placeholder.txt
                overwrite: true
