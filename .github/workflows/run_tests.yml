name: Run Tests

on:
  workflow_call:
    inputs:
      branch:
        description: "Branch to test"
        type: string
        required: true
      solution_name:
        description: "Solution file (.slnx)"
        required: true
        type: string

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - tfm: net8.0
            sdk: 8.0.x
          - tfm: net9.0
            sdk: 9.0.x
          - tfm: net10.0
            sdk: 10.0.x

    env:
      SOLUTION_NAME: ${{ inputs.solution_name }}
      BRANCH_NAME: ${{ inputs.branch }}

    steps:
      - name: Set Build Configuration (Release if main)
        shell: bash
        run: |
          set -euo pipefail
          b="${{ env.BRANCH_NAME }}"
          if [[ "$b" == "main" || "$b" == "refs/heads/main" || "$b" == */main ]]; then
            echo "BUILD_CONFIGURATION=Release" >> $GITHUB_ENV
          else
            echo "BUILD_CONFIGURATION=Debug" >> $GITHUB_ENV
          fi

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Setup .NET SDKs (10 + matrix)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            10.0.x
            ${{ matrix.sdk }}

      - name: Restore
        run: dotnet restore "${{ env.SOLUTION_NAME }}"

      - name: Run tests in test/ for ${{ matrix.tfm }}
        shell: bash
        run: |
          set -euo pipefail

          tfm="${{ matrix.tfm }}"
          mkdir -p "TestResults/$tfm"

          ran_any=false

          # Find all csproj under test/, but skip Benchmark projects
          while IFS= read -r proj; do
            name="$(basename "$proj" .csproj)"
            log="TestResults/$tfm/${name}-${tfm}.log"

            echo "=== dotnet test $proj ($tfm) ==="

            set +e
            dotnet test "$proj" \
              --no-restore \
              --configuration "$BUILD_CONFIGURATION" \
              --framework "$tfm" \
              --logger "trx;LogFileName=${name}-${tfm}.trx" \
              --results-directory "TestResults/$tfm" \
              2>&1 | tee "$log"
            status=${PIPESTATUS[0]}
            set -e

            if [[ $status -eq 0 ]]; then
              ran_any=true
              continue
            fi

            # If project doesn't target this TFM, skip it (don’t fail the run)
            if grep -qiE "does not support|not supported|not a valid.*framework|The framework '.*' was not found" "$log"; then
              echo "↪️ Skipping $proj (doesn't target $tfm)"
              continue
            fi

            echo "❌ Tests failed for $proj on $tfm"
            exit $status
          done < <(find test -name "*.csproj" -print | grep -vi "Benchmark")

          if [[ "$ran_any" == "false" ]]; then
            echo "⚠️ No test projects ran for $tfm (none target it)."
            echo "No $tfm test results" > "TestResults/$tfm/placeholder.txt"
            exit 1
          fi

      - name: Upload ${{ matrix.tfm }} Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.tfm }}
          path: |
            TestResults/${{ matrix.tfm }}/*.trx
            TestResults/${{ matrix.tfm }}/placeholder.txt
            TestResults/${{ matrix.tfm }}/*.log
          overwrite: true
