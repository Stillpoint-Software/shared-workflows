name: Test

on:
  workflow_call:
    inputs:
      branch:
        description: "Branch to test"
        type: string
        required: true
      solution_name:
        description: "Solution file to build and test"
        required: true
        type: string

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      SOLUTION_NAME: ${{ inputs.solution_name }}
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

    steps:
      - name: Set Build Configuration (Release if main)
        run: |
          if [ "${{ env.BRANCH_NAME }}" = "main" ]; then
            echo "BUILD_CONFIGURATION=Release" >> $GITHUB_ENV
          else
            echo "BUILD_CONFIGURATION=Debug" >> $GITHUB_ENV
          fi

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Setup .NET SDKs
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            10.0.x
            9.0.x
            8.0.x

      - name: Restore Dependencies
        run: dotnet restore ${{ env.SOLUTION_NAME }}

      - name: Build
        run: dotnet build --no-restore --configuration $BUILD_CONFIGURATION ${{ env.SOLUTION_NAME }}

      - name: Run Tests
        run: |
          mkdir -p TestResults
          found=false

          tfm_file="./TestResults/_tfms.txt"
          : > "$tfm_file"

          for proj in $(find . -name "*.Tests.csproj"); do
            found=true
            frameworks=$(grep -oPm1 "(?<=<TargetFrameworks>)[^<]+" "$proj" || true)
            if [ -z "$frameworks" ]; then
              frameworks=$(grep -oPm1 "(?<=<TargetFramework>)[^<]+" "$proj" || true)
            fi

            for fw in $(echo $frameworks | tr ';' ' '); do
              echo "$fw" >> "$tfm_file"

              results_dir="./TestResults/$fw"
              mkdir -p "$results_dir"
              dotnet test "$proj" \
                --no-build \
                --configuration $BUILD_CONFIGURATION \
                --framework $fw \
                --logger "trx;LogFileName=$(basename $proj)-$fw.trx" \
                --results-directory "$results_dir"
            done
          done

          if [ "$found" = false ]; then
            echo "⚠️ No test projects (*.Tests.csproj) were found."
            exit 1
          fi

          sort -u "$tfm_file" -o "$tfm_file"
          echo "Detected TFMs:"
          cat "$tfm_file"

          if grep -qx "net10.0" "$tfm_file"; then
            echo "PRIMARY_TFM=net10.0" >> $GITHUB_ENV
          elif grep -qx "net9.0" "$tfm_file"; then
            echo "PRIMARY_TFM=net9.0" >> $GITHUB_ENV
          else
            echo "PRIMARY_TFM=" >> $GITHUB_ENV
          fi

      - name: Ensure PRIMARY Results Exist
        if: $PRIMARY_TFM != '' 
        run: |
          mkdir -p "./TestResults/$PRIMARY_TFM"
          if ! compgen -G "./TestResults/$PRIMARY_TFM/*.trx" > /dev/null; then
            echo "⚠️ No $PRIMARY_TFM test results" > "./TestResults/$PRIMARY_TFM/placeholder.txt"
          fi

      - name: Upload PRIMARY Test Results
        if: $PRIMARY_TFM != ''
        uses: actions/upload-artifact@v4
        with:
          name: test-results-$PRIMARY_TFM
          # only upload trx + placeholder, ignore everything else
          path: |
            ./TestResults/$PRIMARY_TFM/*.trx
            ./TestResults/$PRIMARY_TFM/placeholder.txt
          overwrite: true

      - name: Ensure .NET 8.0 Results Exist
        run: |
          mkdir -p ./TestResults/net8.0
          if ! compgen -G "./TestResults/net8.0/*.trx" > /dev/null; then
            echo "⚠️ No .NET 8.0 test results" > ./TestResults/net8.0/placeholder.txt
          fi

      - name: Upload .NET 8.0 Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-net8.0
          path: |
            ./TestResults/net8.0/*.trx
            ./TestResults/net8.0/placeholder.txt
          overwrite: true
          
      - name: Ensure .NET 9.0 Results Exist
        run: |
          mkdir -p ./TestResults/net9.0
          if ! compgen -G "./TestResults/net9.0/*.trx" > /dev/null; then
            echo "⚠️ No .NET 9.0 test results" > ./TestResults/net9.0/placeholder.txt
          fi

      - name: Upload .NET 9.0 Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-net9.0
          path: |
            ./TestResults/net9.0/*.trx
            ./TestResults/net9.0/placeholder.txt

      - name: Ensure .NET 10.0 Results Exist
        run: |
            mkdir -p ./TestResults/net10.0
            if ! compgen -G "./TestResults/net10.0/*.trx" > /dev/null; then
              echo "⚠️ No .NET 10.0 test results" > ./TestResults/net10.0/placeholder.txt
            fi
  
      - name: Upload .NET 10.0 Test Results
        uses: actions/upload-artifact@v4
        with:
            name: test-results-net10.0
            path: |
              ./TestResults/net10.0/*.trx
              ./TestResults/net10.0/placeholder.txt
            overwrite: true
