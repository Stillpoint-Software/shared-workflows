name: template_update

on:
  # Reusable workflow trigger
  workflow_call:
    inputs:
      template_repo:
        required: true
        type: string

jobs:
  update-template:
    runs-on: ubuntu-latest

    steps:
      # ğŸ“¥ 1. Checkout the project that *uses* the template
      - name: Checkout project repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ§¾ 2. Ensure .cookiecutter.json exists (answers file)
      - name: Verify .cookiecutter.json exists
        run: |
          if [ ! -f .cookiecutter.json ]; then
            echo "âŒ Missing .cookiecutter.json in project root."
            exit 1
          fi

      # ğŸŒ¿ 3. Pick develop > main as PR base
      - name: Determine base branch (develop > main)
        id: branch
        run: |
          if git ls-remote --heads origin develop | grep develop; then
            echo "BASE_BRANCH=develop" >> "$GITHUB_ENV"
          else
            echo "BASE_BRANCH=main" >> "$GITHUB_ENV"
          fi

      # ğŸ 4. Install Python & Cookiecutter
      - name: Set up Python & install Cookiecutter
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - run: pip install cookiecutter

      # ğŸ§± 5. Install .NET 9 SDK (for test run)
      - name: Set up .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ğŸ“¦ 6. Clone the template repo
      - name: Clone cookiecutter template repo
        run: git clone "${{ inputs.template_repo }}" template-source

      # ğŸ§  7. Pick sub-template & regenerate project
      - name: Determine sub-template and generate project
        id: generate
        run: |
          TEMPLATE_PATH=""

          if grep -q '"include_aspire": *"yes"' .cookiecutter.json; then
            TEMPLATE_PATH="aspire-project"
          elif grep -q '"include_docker": *"yes"' .cookiecutter.json; then
            TEMPLATE_PATH="docker-project"
          else
            echo "âŒ No valid sub-template selected."
            exit 1
          fi

          echo "Using sub-template: $TEMPLATE_PATH"

          # Tell hooks theyâ€™re in CI / non-interactive mode
          export COOKIECUTTER_NO_INPUT=1

          # Replay answers (can't combine with --no-input)
          cookiecutter "template-source/$TEMPLATE_PATH" \
            --replay-file .cookiecutter.json \
            --output-dir regenerated

          mkdir -p generated-project
          mv regenerated/* generated-project

      # ğŸ†š 8. Diff regenerated vs. current repo
      - name: Compare generated project with current repo
        id: check_diff
        run: |
          diff_output=$(diff -qr generated-project . \
              --exclude=.git \
              --exclude=generated-project \
              --exclude=template-source \
              --exclude=.cookiecutter.json || true)
          echo "$diff_output"
          echo "DIFF_FOUND=$(test -n "$diff_output" && echo true || echo false)" >> "$GITHUB_ENV"

      # âŒ 9. Bail early if nothing changed
      - name: Stop if no changes detected
        if: env.DIFF_FOUND == 'false'
        run: exit 0

      # 10. Commit regenerated code on a new branch
      - name: Create and push update branch
        run: |
          # â”€â”€ remove the nested Git repo so the tree is clean â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          rm -rf template-source
      
          BRANCH="template-update-$(date +%s)"
          echo "UPDATE_BRANCH=$BRANCH" >> "$GITHUB_ENV"
          git checkout -b "$BRANCH"
      
          # â”€â”€ copy regenerated project into the repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ -d generated-project ]; then
            rsync -av --delete generated-project/ . \
              --exclude='.git' \
              --exclude='template-source' \
              --exclude='generated-project'
          fi
      
          # â”€â”€ now we can drop the staging folder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          rm -rf generated-project
      
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add -A
      
          # Commit only when there really are staged changes
          if ! git diff --cached --quiet; then
            git commit -m "chore: update from cookiecutter template"
            git push origin "$BRANCH"
          else
            echo "â„¹ï¸  No changes after rsync â€“ skipping branch push."
            git checkout -
            git branch -D "$BRANCH"
          fi

      # ğŸ§ª 11. Run tests & collect results
      - name: Run tests
        continue-on-error: true           # keep workflow alive on test failure
        run: |
          mkdir -p test-results
          dotnet restore
          dotnet test \
            --configuration Release \
            --no-build \
            --logger "trx;LogFileName=test-results.trx" \
            --results-directory "$(pwd)/test-results"

      # ğŸ“¤ 12. Upload test results artifact (only if .trx exists)
      - name: Upload test results
        if: ${{ always() && hashFiles('test-results/*.trx') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/*.trx

      # ğŸ› ï¸ 13. Open pull request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Update from Cookiecutter Template"
          body: |
            This PR includes updates generated from the template:

            â€¢ Source : `${{ inputs.template_repo }}`
            â€¢ Base   : `${{ env.BASE_BRANCH }}`  
            â€¢ CI     : test results attached as **test-results** artifact

            _Review carefully and merge when ready._
          branch: ${{ env.UPDATE_BRANCH }}
          base: ${{ env.BASE_BRANCH }}
