name: Template Update

on:
  workflow_call:
    inputs:
      template_repo:
        description: "URL of the Cookiecutter template repo"
        required: true
        type: string
      repo_branch:
        description: "Branch of the project repo to update"
        required: true
        type: string
      update_workflows:
        description: "Include .github/workflows updates from template? (true/false)"
        required: false
        type: boolean
        default: false
    secrets:
      TEMPLATE_UPDATE_TOKEN:
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  check-update:
    runs-on: ubuntu-latest
    outputs:
      sha_changed: ${{ steps.compare.outputs.sha_changed }}
      old_sha: ${{ steps.old_sha.outputs.sha }}
      new_sha: ${{ steps.new_sha.outputs.sha }}

    steps:
      - name: Checkout project repo (cookiecutter metadata only)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ inputs.repo_branch }}
          sparse-checkout: .cookiecutter.json
          sparse-checkout-cone-mode: false

      - name: Read old template SHA
        id: old_sha
        shell: bash
        run: |
          set -euo pipefail
          SHA=$(jq -r '.cookiecutter.template_sha // empty' .cookiecutter.json)
          if [ -z "$SHA" ]; then
            echo "::error ::.cookiecutter.json is missing cookiecutter.template_sha"
            exit 1
          fi
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Fetch new template SHA
        id: new_sha
        shell: bash
        run: |
          set -euo pipefail
          echo "sha=$(git ls-remote '${{ inputs.template_repo }}' HEAD | cut -f1)" >> "$GITHUB_OUTPUT"

      - name: Compare SHAs
        id: compare
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.old_sha.outputs.sha }}" = "${{ steps.new_sha.outputs.sha }}" ]; then
            echo "âœ‚ï¸ SHA unchanged; nothing to update."
            echo "sha_changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "sha_changed=true" >> "$GITHUB_OUTPUT"
          fi

  template-update:
    needs: check-update
    if: needs.check-update.outputs.sha_changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Resolve auth token
        id: auth
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ inputs.update_workflows }}" = "true" ]; then
            if [ -z "${{ secrets.TEMPLATE_UPDATE_TOKEN }}" ]; then
              echo "::error ::update_workflows=true requires secrets.TEMPLATE_UPDATE_TOKEN"
              exit 1
            fi
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "token=${{ secrets.TEMPLATE_UPDATE_TOKEN }}" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "token=${{ github.token }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout project repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ inputs.repo_branch }}
          fetch-depth: 0
          submodules: false
          token: ${{ steps.auth.outputs.token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        shell: bash
        run: pip install "cookiecutter==2.6.0"

      - name: Prepare branch name
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          NEW_SHA="${{ needs.check-update.outputs.new_sha }}"
          echo "name=template-update-${NEW_SHA}" >> "$GITHUB_OUTPUT"

      - name: Check if PR or branch already exists
        shell: bash
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"

          BRANCH="${{ steps.branch.outputs.name }}"
          BASE="${{ inputs.repo_branch }}"

          URL=$(gh pr list --state open --head "$BRANCH" --base "$BASE" --json url --jq '.[0].url')
          if [ -n "$URL" ] && [ "$URL" != "null" ]; then
            echo "::error ::An open PR already exists for branch '$BRANCH': $URL"
            exit 1
          fi

          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            echo "::error ::Branch '$BRANCH' already exists."
            exit 1
          fi

      - name: Clone template and prepare cookiecutter replay files
        shell: bash
        run: |
          set -euo pipefail

          rm -rf /tmp/template-source || true
          rm -f /tmp/replay.raw.json || true
          rm -f /tmp/replay.pruned.json || true

          git clone '${{ inputs.template_repo }}' /tmp/template-source

          echo "GITHUB_WORKSPACE is: $GITHUB_WORKSPACE"

          cp "$GITHUB_WORKSPACE/.cookiecutter.json" /tmp/replay.raw.json
          cp /tmp/replay.raw.json /tmp/replay.pruned.json

          echo "=== Raw replay file used: /tmp/replay.raw.json ==="
          cat /tmp/replay.raw.json

      - name: Backfill replay for OLD template (avoid prompts)
        shell: bash
        run: |
          set -euo pipefail
          OLD_SHA="${{ needs.check-update.outputs.old_sha }}"

          cd /tmp/template-source
          git checkout -f "$OLD_SHA"

          python - <<'PY'
          import json
          from pathlib import Path

          replay_path = Path("/tmp/replay.raw.json")
          template_cookiecutter = Path("/tmp/template-source/cookiecutter.json")

          replay = json.loads(replay_path.read_text(encoding="utf-8"))
          ctx = replay.get("cookiecutter", {})

          tmpl = json.loads(template_cookiecutter.read_text(encoding="utf-8"))

          SPECIAL = {"__prompts__", "_copy_without_render", "_jinja2_env_vars"}

          def choose_default(v):
              if isinstance(v, list) and v:
                  low = [str(x).lower() for x in v]
                  if "yes" in low and "no" in low:
                      return v[low.index("no")]
                  if "development" in low:
                      return v[low.index("development")]
                  return v[0]
              return v

          added = {}
          for k, v in tmpl.items():
              if k in SPECIAL:
                  continue
              if k not in ctx:
                  ctx[k] = choose_default(v)
                  added[k] = ctx[k]

          replay["cookiecutter"] = ctx
          replay_path.write_text(json.dumps(replay, indent=2), encoding="utf-8")

          print("Backfilled missing keys for OLD template:")
          for k, v in added.items():
              print(f"  - {k}: {v!r}")
          PY

      - name: Render template at OLD_SHA (uses backfilled raw replay)
        id: render_old
        shell: bash
        env:
          CI: "true"
          COOKIECUTTER_NO_INPUT: "1"
          STILLPOINT_TEMPLATE_RUNNER: "github_actions"
          TEMPLATE_UPDATE_RUNNER: "github_actions"
        run: |
          set -euo pipefail

          REPLAY_FILE="/tmp/replay.raw.json"

          rm -rf ~/.cookiecutters/* || true
          rm -rf /tmp/rendered_old || true
          mkdir -p /tmp/rendered_old

          cookiecutter /tmp/template-source \
            --replay \
            --replay-file "$REPLAY_FILE" \
            --overwrite-if-exists \
            --output-dir /tmp/rendered_old

          PROJECT_ROOT="$(find /tmp/rendered_old -mindepth 1 -maxdepth 1 -type d | head -n 1 || true)"
          if [ -z "$PROJECT_ROOT" ]; then
            echo "::error ::Could not locate rendered project root under /tmp/rendered_old"
            find /tmp/rendered_old -maxdepth 2 -type d -print || true
            exit 1
          fi

          echo "project_root=$PROJECT_ROOT" >> "$GITHUB_OUTPUT"

      - name: Checkout NEW_SHA and prune replay for NEW template
        shell: bash
        run: |
          set -euo pipefail
          NEW_SHA="${{ needs.check-update.outputs.new_sha }}"

          cd /tmp/template-source
          git checkout -f "$NEW_SHA"

          cp /tmp/replay.raw.json /tmp/replay.pruned.json

          if [ -f "/tmp/template-source/hooks/prune_cookiecutter_json.py" ] && [ -f "/tmp/template-source/hooks/deprecated.json" ]; then
            echo "ðŸ§¹ Pruning deprecated variables (based on NEW template)"
            python /tmp/template-source/hooks/prune_cookiecutter_json.py \
              --cookie /tmp/replay.pruned.json \
              --deprecations /tmp/template-source/hooks/deprecated.json
          else
            echo "â„¹ï¸ prune_cookiecutter_json.py or deprecated.json not found at NEW_SHA; skipping prune."
          fi

          echo "=== Pruned replay file used: /tmp/replay.pruned.json ==="
          cat /tmp/replay.pruned.json

      - name: Render template at NEW_SHA (uses pruned replay)
        id: render_new
        shell: bash
        env:
          CI: "true"
          COOKIECUTTER_NO_INPUT: "1"
          STILLPOINT_TEMPLATE_RUNNER: "github_actions"
          TEMPLATE_UPDATE_RUNNER: "github_actions"
        run: |
          set -euo pipefail

          REPLAY_FILE="/tmp/replay.pruned.json"

          rm -rf ~/.cookiecutters/* || true
          rm -rf /tmp/rendered_new || true
          mkdir -p /tmp/rendered_new

          cookiecutter /tmp/template-source \
            --replay \
            --replay-file "$REPLAY_FILE" \
            --overwrite-if-exists \
            --output-dir /tmp/rendered_new

          PROJECT_ROOT="$(find /tmp/rendered_new -mindepth 1 -maxdepth 1 -type d | head -n 1 || true)"
          if [ -z "$PROJECT_ROOT" ]; then
            echo "::error ::Could not locate rendered project root under /tmp/rendered_new"
            find /tmp/rendered_new -maxdepth 2 -type d -print || true
            exit 1
          fi

          echo "project_root=$PROJECT_ROOT" >> "$GITHUB_OUTPUT"

      - name: Create update branch
        shell: bash
        run: |
          set -euo pipefail
          unset GIT_DIR GIT_WORK_TREE || true
          git -C "$GITHUB_WORKSPACE" checkout -b "${{ steps.branch.outputs.name }}"

      - name: Apply delta (OLD render â†’ NEW render) to repo (protect .git)
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
      
          if [ ! -e ".git" ]; then
            echo "::error ::.git is missing in workspace before delta apply."
            pwd
            ls -la
            exit 1
          fi
      
          rm -rf /tmp/workspace_git || true
          mv .git /tmp/workspace_git
          trap 'cd "$GITHUB_WORKSPACE"; [ -e /tmp/workspace_git ] && mv /tmp/workspace_git .git' EXIT
      
          OLD_ROOT="${{ steps.render_old.outputs.project_root }}"
          NEW_ROOT="${{ steps.render_new.outputs.project_root }}"
      
          RSYNC_EXCLUDES=(
            --exclude ".git"
            --exclude ".git/"
            --exclude "templates/"
            --exclude "templates/**"
            --exclude "version.json"
          )
      
          if [ "${{ steps.auth.outputs.enabled }}" != "true" ]; then
            RSYNC_EXCLUDES+=(--exclude ".github/workflows/")
          fi
      
          rsync -a --checksum \
            "${RSYNC_EXCLUDES[@]}" \
            --compare-dest="$OLD_ROOT/" \
            "$NEW_ROOT/" \
            "$GITHUB_WORKSPACE/"
      
          cd "$OLD_ROOT"
          while IFS= read -r rel; do
            [ -z "$rel" ] && continue
            rel="${rel#./}"
      
            if [ "${{ steps.auth.outputs.enabled }}" != "true" ] && [[ "$rel" == .github/workflows/* ]]; then
              continue
            fi
      
            # Never delete repo-owned files
            if [ "$rel" = "version.json" ]; then
              continue
            fi
      
            if [ ! -e "$NEW_ROOT/$rel" ] && [ -e "$GITHUB_WORKSPACE/$rel" ]; then
              echo "Deleting removed-by-template: $rel"
              rm -f "$GITHUB_WORKSPACE/$rel" || true
            fi
          done < <(find . -type f -print)
      
          cd "$GITHUB_WORKSPACE"
      
          # Never include template-only scaffolding
          rm -rf "$GITHUB_WORKSPACE/templates" || true
      
          git rev-parse --is-inside-work-tree

      - name: Update .cookiecutter.json
        shell: bash
        run: |
          set -euo pipefail
          cp /tmp/replay.pruned.json "$GITHUB_WORKSPACE/.cookiecutter.json"

          NEW_SHA="${{ needs.check-update.outputs.new_sha }}"
          jq ".cookiecutter.template_sha = \"${NEW_SHA}\"" \
            "$GITHUB_WORKSPACE/.cookiecutter.json" > "$GITHUB_WORKSPACE/tmp.json" \
            && mv "$GITHUB_WORKSPACE/tmp.json" "$GITHUB_WORKSPACE/.cookiecutter.json"

      - name: Commit changes
        id: commit
        shell: bash
        run: |
          set -euo pipefail
          unset GIT_DIR GIT_WORK_TREE || true

          OLD_SHA="${{ needs.check-update.outputs.old_sha }}"
          NEW_SHA="${{ needs.check-update.outputs.new_sha }}"

          git -C "$GITHUB_WORKSPACE" config user.name "GitHub Actions Bot"
          git -C "$GITHUB_WORKSPACE" config user.email "actions@github.com"
          git -C "$GITHUB_WORKSPACE" add -A

          if git -C "$GITHUB_WORKSPACE" diff --cached --quiet; then
            echo "No changes; skipping PR."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git -C "$GITHUB_WORKSPACE" commit -m "chore: update from template ${OLD_SHA} â†’ ${NEW_SHA}"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Push branch and create PR
        if: steps.commit.outputs.has_changes == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          set -euo pipefail
          unset GIT_DIR GIT_WORK_TREE || true

          OLD_SHA="${{ needs.check-update.outputs.old_sha }}"
          NEW_SHA="${{ needs.check-update.outputs.new_sha }}"
          BRANCH="${{ steps.branch.outputs.name }}"

          git -C "$GITHUB_WORKSPACE" push -u origin "$BRANCH"

          gh pr create \
            --title "chore: update from template ${OLD_SHA} â†’ ${NEW_SHA}" \
            --body "Updates from template SHA \`${OLD_SHA}\` â†’ \`${NEW_SHA}\`" \
            --base '${{ inputs.repo_branch }}' \
            --head "$BRANCH"
