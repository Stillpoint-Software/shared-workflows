name: Template Update

on:
  workflow_call:
    inputs:
      template_repo:
        description: 'URL of the Cookiecutter template repo'
        required: true
        type: string
      repo_branch:
        description: 'Branch of the project repo to update'
        required: true
        type: string
      update_workflows:
        description: 'Include .github/workflows updates from template?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  check-update:
    runs-on: ubuntu-latest
    outputs:
      sha_changed: ${{ steps.compare.outputs.sha_changed }}
      old_sha: ${{ steps.old_sha.outputs.sha }}
      new_sha: ${{ steps.new_sha.outputs.sha }}

    steps:
      - name: Checkout project repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ inputs.repo_branch }}
          sparse-checkout: .cookiecutter.json
          sparse-checkout-cone-mode: false

      - name: Read old template SHA
        id: old_sha
        run: |
          SHA=$(jq -r '.cookiecutter.template_sha // empty' .cookiecutter.json)
          if [ -z "$SHA" ]; then
            echo "::error ::.cookiecutter.json is missing cookiecutter.template_sha"
            exit 1
          fi
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Fetch new template SHA
        id: new_sha
        run: |
          echo "sha=$(git ls-remote '${{ inputs.template_repo }}' HEAD | cut -f1)" >> "$GITHUB_OUTPUT"

      - name: Compare SHAs
        id: compare
        run: |
          if [ "${{ steps.old_sha.outputs.sha }}" = "${{ steps.new_sha.outputs.sha }}" ]; then
            echo "✂️ SHA unchanged; nothing to update."
            echo "sha_changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "sha_changed=true" >> "$GITHUB_OUTPUT"
          fi

  template-update:
    needs: check-update
    if: needs.check-update.outputs.sha_changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout project repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ inputs.repo_branch }}
          fetch-depth: 0
          submodules: false

      - name: Capture base SHA
        shell: bash
        run: |
          echo "BASE_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install cookiecutter

      - name: Check if update branch already exists
        run: |
          BRANCH="template-update-${{ needs.check-update.outputs.new_sha }}"
          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            echo "::error ::Branch '$BRANCH' already exists. A template update PR may already be open."
            exit 1
          fi

      - name: Clone template at new SHA
        run: git clone '${{ inputs.template_repo }}' /tmp/template-source

      - name: Run cookiecutter replay
        run: |
          rm -rf ~/.cookiecutters/*
          cookiecutter /tmp/template-source \
            --replay-file .cookiecutter.json \
            --overwrite-if-exists \
            --output-dir /tmp/rendered

      - name: Get rendered project directory name
        id: rendered_dir
        run: |
          DIR=$(ls /tmp/rendered)
          echo "name=$DIR" >> "$GITHUB_OUTPUT"

      - name: Create template branch, merge, and push
        id: merge
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN || github.token }}
        run: |
          set -euo pipefail

          RENDERED="/tmp/rendered/${{ steps.rendered_dir.outputs.name }}"
          OLD_SHA="${{ needs.check-update.outputs.old_sha }}"
          NEW_SHA="${{ needs.check-update.outputs.new_sha }}"
          BRANCH="template-update-${NEW_SHA}"

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          CURRENT_BRANCH="${{ inputs.repo_branch }}"

          # Create an orphan branch with the rendered template content
          git checkout --orphan template-rendered
          git rm -rf --cached . >/dev/null 2>&1 || true
          rm -rf $(ls -A | grep -v '^\.git$') || true

          # Copy rendered content
          cp -r "$RENDERED"/. .

          # Preserve .cookiecutter.json from original branch with updated SHA
          git show "${CURRENT_BRANCH}:.cookiecutter.json" > .cookiecutter.json
          jq ".cookiecutter.template_sha = \"${NEW_SHA}\"" \
            .cookiecutter.json > tmp.json && mv tmp.json .cookiecutter.json

          python /tmp/template-source/hooks/prune_cookiecutter_json.py --cookie .cookiecutter.json --deprecations templates/deprecations.json

          git add -A
          git commit -m "Template render at ${NEW_SHA}"

          TEMPLATE_COMMIT=$(git rev-parse HEAD)

          # Switch back to repo branch and create update branch
          git checkout "${CURRENT_BRANCH}"
          git checkout -b "$BRANCH"

          MERGE_HAD_CONFLICTS=false

          # Attempt the merge; if it fails, keep conflict markers in working tree
          if git merge "$TEMPLATE_COMMIT" --allow-unrelated-histories --no-edit -m "chore: update from template ${OLD_SHA} → ${NEW_SHA}"; then
            MERGE_HAD_CONFLICTS=false
          else
            echo "::warning ::Merge had conflicts. They will be included in the PR for manual resolution."
            MERGE_HAD_CONFLICTS=true
          fi

          # Conditionally revert .github/workflows back to base (omit workflow updates)
          if [ "${{ inputs.update_workflows }}" != "true" ]; then
            echo "update_workflows=false → reverting .github/workflows to base commit: $BASE_SHA"
            if [ -d ".github/workflows" ]; then
              git restore --source="$BASE_SHA" --staged --worktree .github/workflows || true
            fi
          fi

          # If merge had conflicts, commit AFTER optional workflow revert
          if [ "$MERGE_HAD_CONFLICTS" = "true" ]; then
            git add -A
            git commit -m "chore: update from template ${OLD_SHA} → ${NEW_SHA} (with conflicts)"
          else
            # Merge succeeded and created a merge commit already.
            # If we reverted workflows (or made any post-merge edits), commit those changes.
            if ! git diff --cached --quiet; then
              git add -A
              git commit -m "chore: omit workflow updates"
            fi
          fi

          # Ensure origin exists
          if ! git remote get-url origin >/dev/null 2>&1; then
            git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          fi

          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "merge_had_conflicts=$MERGE_HAD_CONFLICTS" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN || github.token }}
        run: |
          OLD_SHA="${{ needs.check-update.outputs.old_sha }}"
          NEW_SHA="${{ needs.check-update.outputs.new_sha }}"
          BRANCH="${{ steps.merge.outputs.branch }}"
          MERGE_HAD_CONFLICTS="${{ steps.merge.outputs.merge_had_conflicts }}"

          if [ "$MERGE_HAD_CONFLICTS" = "true" ]; then
            BODY="Updates from template SHA \`${OLD_SHA}\` → \`${NEW_SHA}\`

          ⚠️ **Merge conflicts detected**: This PR contains conflict markers that need manual resolution. Search for \`<<<<<<<\` in the changed files."
          else
            BODY="Updates from template SHA \`${OLD_SHA}\` → \`${NEW_SHA}\`"
          fi

          gh pr create \
            --title "chore: update from template ${OLD_SHA} → ${NEW_SHA}" \
            --body "$BODY" \
            --base '${{ inputs.repo_branch }}' \
            --head "$BRANCH"
