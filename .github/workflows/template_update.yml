name: Template Update

on:
  workflow_call:
    inputs:
      template_repo:
        description: 'URL of the Cookiecutter template repo'
        required: true
        type: string
      repo_branch:
        description: 'Branch of the project repo to update'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  check-update:
    runs-on: ubuntu-latest
    outputs:
      sha_changed: ${{ steps.compare.outputs.sha_changed }}
      old_sha: ${{ steps.old_sha.outputs.sha }}
      new_sha: ${{ steps.new_sha.outputs.sha }}

    steps:
    - name: Checkout project repo
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        ref: ${{ inputs.repo_branch }}
        sparse-checkout: .cookiecutter.json
        sparse-checkout-cone-mode: false

    - name: Read old template SHA
      id: old_sha
      run: |
        SHA=$(jq -r '.cookiecutter.template_sha // empty' .cookiecutter.json)
        if [ -z "$SHA" ]; then
          echo "::error ::.cookiecutter.json is missing cookiecutter.template_sha"
          exit 1
        fi
        echo "sha=$SHA" >> "$GITHUB_OUTPUT"

    - name: Fetch new template SHA
      id: new_sha
      run: |
        echo "sha=$(git ls-remote '${{ inputs.template_repo }}' HEAD | cut -f1)" >> "$GITHUB_OUTPUT"

    - name: Compare SHAs
      id: compare
      run: |
        if [ "${{ steps.old_sha.outputs.sha }}" = "${{ steps.new_sha.outputs.sha }}" ]; then
          echo "✂️ SHA unchanged; nothing to update."
          echo "sha_changed=false" >> "$GITHUB_OUTPUT"
        else
          echo "sha_changed=true" >> "$GITHUB_OUTPUT"
        fi

  template-update:
    needs: check-update
    if: needs.check-update.outputs.sha_changed == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout project repo
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        ref: ${{ inputs.repo_branch }}
        fetch-depth: 0
        submodules: false

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install cookiecutter

    - name: Check if update branch already exists
      run: |
        BRANCH="template-update-${{ needs.check-update.outputs.new_sha }}"
        if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
          echo "::error ::Branch '$BRANCH' already exists. A template update PR may already be open."
          exit 1
        fi

    - name: Clone template at new SHA
      run: git clone '${{ inputs.template_repo }}' /tmp/template-source

    - name: Run cookiecutter replay
      run: |
        rm -rf ~/.cookiecutters/*
        cookiecutter /tmp/template-source \
          --replay-file .cookiecutter.json \
          --overwrite-if-exists \
          --output-dir /tmp/rendered

    - name: Get rendered project directory name
      id: rendered_dir
      run: |
        DIR=$(ls /tmp/rendered)
        echo "name=$DIR" >> "$GITHUB_OUTPUT"

    - name: Create template branch and merge
      id: merge
      shell: bash
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        
        RENDERED="/tmp/rendered/${{ steps.rendered_dir.outputs.name }}"
        OLD_SHA="${{ needs.check-update.outputs.old_sha }}"
        NEW_SHA="${{ needs.check-update.outputs.new_sha }}"
        BRANCH="template-update-${NEW_SHA}"
        
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        # Save remote URL before any operations
        REMOTE_URL=$(git remote get-url origin)
        
        # Save current branch name
        CURRENT_BRANCH="${{ inputs.repo_branch }}"
        
        # Create an orphan branch with the rendered template content
        git checkout --orphan template-rendered
        git rm -rf --cached .
        rm -rf $(ls -A | grep -v '^\.git$')
        
        # Copy rendered content
        cp -r "$RENDERED"/. .
        
        # Preserve .cookiecutter.json from original branch with updated SHA
        git show "${CURRENT_BRANCH}:.cookiecutter.json" > .cookiecutter.json
        jq ".cookiecutter.template_sha = \"${NEW_SHA}\"" \
          .cookiecutter.json > tmp.json && mv tmp.json .cookiecutter.json
        
        git add -A
        git commit -m "Template render at ${NEW_SHA}"
        
        # Save the commit SHA of template-rendered
        TEMPLATE_COMMIT=$(git rev-parse HEAD)
        
        # Switch back to repo branch and create update branch
        git checkout "${CURRENT_BRANCH}"
        git checkout -b "$BRANCH"
        
        # Merge using the commit SHA instead of branch name
        if git merge "$TEMPLATE_COMMIT" --allow-unrelated-histories --no-edit -m "chore: update from template ${OLD_SHA} → ${NEW_SHA}"; then
          echo "merge_had_conflicts=false" >> "$GITHUB_OUTPUT"
        else
          echo "::warning ::Merge had conflicts. They will be included in the PR for manual resolution."
          echo "merge_had_conflicts=true" >> "$GITHUB_OUTPUT"
          git add -A
          git commit -m "chore: update from template ${OLD_SHA} → ${NEW_SHA} (with conflicts)"
        fi
        
        # Ensure remote is set (may have been lost)
        if ! git remote get-url origin >/dev/null 2>&1; then
          git remote add origin "$REMOTE_URL"
        fi
        
        # Configure authentication for push
        git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
        
        git push origin "$BRANCH"
        echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

    - name: Create pull request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        OLD_SHA="${{ needs.check-update.outputs.old_sha }}"
        NEW_SHA="${{ needs.check-update.outputs.new_sha }}"
        BRANCH="${{ steps.merge.outputs.branch }}"
        MERGE_HAD_CONFLICTS="${{ steps.merge.outputs.merge_had_conflicts }}"

        if [ "$MERGE_HAD_CONFLICTS" = "true" ]; then
          BODY="Updates from template SHA \`${OLD_SHA}\` → \`${NEW_SHA}\`

        ⚠️ **Merge conflicts detected**: This PR contains conflict markers that need manual resolution. Search for \`<<<<<<<\` in the changed files."
        else
          BODY="Updates from template SHA \`${OLD_SHA}\` → \`${NEW_SHA}\`"
        fi

        gh pr create \
          --title "chore: update from template ${OLD_SHA} → ${NEW_SHA}" \
          --body "$BODY" \
          --base '${{ inputs.repo_branch }}' \
          --head "$BRANCH"
