# .github/workflows/Template_Update.yml
name: Template_Update

permissions:
  contents: write
  pull-requests: write

on:
  workflow_call:
    inputs:
      template_repo:
        description: 'URL of the Cookiecutter template repo'
        required: true
        type: string
      repo_branch:
        description: 'Branch of the project repo to update'
        required: true
        type: string

jobs:
  template-update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout project repo
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        ref: ${{ inputs.repo_branch }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install cookiecutter jq

    - name: Read old template SHA
      id: old_sha
      run: |
        SHA=$(jq -r '.cookiecutter.template_sha // empty' .cookiecutter.json)
        if [ -z "$SHA" ]; then
          echo "::error ::.cookiecutter.json is missing cookiecutter.template_sha"
          exit 1
        fi
        echo "sha=$SHA" >> "$GITHUB_OUTPUT"

    - name: Fetch new template SHA
      id: new_sha
      run: |
        echo "sha=$(git ls-remote '${{ inputs.template_repo }}' HEAD | cut -f1)" >> "$GITHUB_OUTPUT"

    - name: Determine if Template was updated
      run: |
        if [ "${{ steps.old_sha.outputs.sha }}" = "${{ steps.new_sha.outputs.sha }}" ]; then
          echo "SHA_CHANGED=false" >> "$GITHUB_ENV"
        else
          echo "SHA_CHANGED=true"  >> "$GITHUB_ENV"
        fi

    - name: Exit if SHA unchanged
      if: env.SHA_CHANGED == 'false'
      run: echo "✂️  SHA unchanged; nothing to update."

    - name: Clone template at OLD SHA
      if: env.SHA_CHANGED == 'true'
      run: |
        git clone '${{ inputs.template_repo }}' base-template
        git -C base-template checkout '${{ steps.old_sha.outputs.sha }}'

    - name: Clone template at NEW SHA
      if: env.SHA_CHANGED == 'true'
      run: git clone '${{ inputs.template_repo }}' template-source

    - name: Render OLD template (base-template → template-base)
      if: env.SHA_CHANGED == 'true'
      run: |
        rm -rf ~/.cookiecutters/*
        mkdir -p template-base
        # jq '.cookiecutter.templates = "main"' .cookiecutter.json > tmp && mv tmp .cookiecutter.json   # <-- uncomment if keeping the variable
        cookiecutter base-template \
          --replay-file .cookiecutter.json \
          --overwrite-if-exists \
          --output-dir template-base

    - name: Render NEW template (template-source → template-new)
      if: env.SHA_CHANGED == 'true'
      run: |
        rm -rf ~/.cookiecutters/*
        mkdir -p template-new
        # jq '.cookiecutter.templates = "main"' .cookiecutter.json > tmp && mv tmp .cookiecutter.json   # <-- same note
        cookiecutter template-source \
          --replay-file .cookiecutter.json \
          --overwrite-if-exists \
          --output-dir template-new

    - name: Apply patch & raise PR
      if: env.SHA_CHANGED == 'true'
      shell: bash
      run: |
        diff -ruN template-base template-new > update.patch || true

        if [ ! -s update.patch ]; then
          echo "ℹ️  No template diffs; only SHA bump will occur."
        else
          if ! git apply --index --3way update.patch; then
            echo "::error ::Merge conflicts detected; aborting."
            exit 1
          fi
          echo "✅ Applied template changes"
        fi

        jq ".cookiecutter.template_sha = \"${{ steps.new_sha.outputs.sha }}\"" \
          .cookiecutter.json > tmp && mv tmp .cookiecutter.json
        git add .cookiecutter.json

        BRANCH="template-update-${{ steps.new_sha.outputs.sha }}"
        git checkout -b "$BRANCH"
        git config user.name  "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git commit -am "chore: merge template updates ${{ steps.old_sha.outputs.sha }} → ${{ steps.new_sha.outputs.sha }}"
        git push origin "$BRANCH"

    - name: Create pull request
      if: env.SHA_CHANGED == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr create \
          --title "chore: merge template updates ${{ steps.old_sha.outputs.sha }} → ${{ steps.new_sha.outputs.sha }}" \
          --body  "Updates cookiecutter.template_sha from ${{ steps.old_sha.outputs.sha }} to ${{ steps.new_sha.outputs.sha }}" \
          --base  '${{ inputs.repo_branch }}' \
          --head  "$BRANCH"
