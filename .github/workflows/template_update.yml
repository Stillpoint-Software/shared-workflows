name: Template Update

on:
  workflow_call:
    inputs:
      template_repo:
        description: 'URL of the Cookiecutter template repo'
        required: true
        type: string
      repo_branch:
        description: 'Branch of the project repo to update'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  template-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout project repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ inputs.repo_branch }}
          fetch-depth: 0
          submodules: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install cookiecutter

      - name: Read old template SHA
        id: old_sha
        shell: bash
        run: |
          SHA=$(jq -r '.cookiecutter.template_sha // empty' .cookiecutter.json)
          if [ -z "$SHA" ]; then
            echo "::error ::.cookiecutter.json is missing cookiecutter.template_sha"
            exit 1
          fi
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Fetch new template SHA
        id: new_sha
        shell: bash
        run: |
          echo "sha=$(git ls-remote '${{ inputs.template_repo }}' HEAD | cut -f1)" >> "$GITHUB_OUTPUT"

      - name: Determine if Template was updated
        shell: bash
        run: |
          if [ "${{ steps.old_sha.outputs.sha }}" = "${{ steps.new_sha.outputs.sha }}" ]; then
            echo "SHA_CHANGED=false" >> "$GITHUB_ENV"
          else
            echo "SHA_CHANGED=true"  >> "$GITHUB_ENV"
          fi

      - name: Exit if SHA unchanged
        if: env.SHA_CHANGED == 'false'
        run: echo "✂️  SHA unchanged; nothing to update."

            - name: Render templates + apply patch (temp work OUTSIDE repo) + commit branch
        if: env.SHA_CHANGED == 'true'
        shell: bash
        run: |
          set -euo pipefail

          WORKDIR="${RUNNER_TEMP}/cc-template-update"
          BASE_REPO="${WORKDIR}/base-template"
          NEW_REPO="${WORKDIR}/template-source"
          OUT_BASE="${WORKDIR}/template-base"
          OUT_NEW="${WORKDIR}/template-new"
          PATCHFILE="${WORKDIR}/update.patch"

          rm -rf "$WORKDIR"
          mkdir -p "$WORKDIR" "$OUT_BASE" "$OUT_NEW"

          echo "Cloning OLD template SHA..."
          git clone '${{ inputs.template_repo }}' "$BASE_REPO"
          git -C "$BASE_REPO" checkout '${{ steps.old_sha.outputs.sha }}'

          echo "Cloning NEW template SHA..."
          git clone '${{ inputs.template_repo }}' "$NEW_REPO"

          echo "Rendering OLD template..."
          rm -rf ~/.cookiecutters/*
          cookiecutter "$BASE_REPO" \
            --replay-file .cookiecutter.json \
            --overwrite-if-exists \
            --output-dir "$OUT_BASE"

          echo "Rendering NEW template..."
          rm -rf ~/.cookiecutters/*
          cookiecutter "$NEW_REPO" \
            --replay-file .cookiecutter.json \
            --overwrite-if-exists \
            --output-dir "$OUT_NEW"

          echo "Diffing renders (git-style patch, relative paths)..."
          BASE_ROOT="$(find "$OUT_BASE" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | head -1)"
          NEW_ROOT="$(find "$OUT_NEW"  -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | head -1)"

          if [ -z "$BASE_ROOT" ] || [ -z "$NEW_ROOT" ] || [ "$BASE_ROOT" != "$NEW_ROOT" ]; then
            echo "::error ::Rendered root folder mismatch: base='$BASE_ROOT' new='$NEW_ROOT'"
            exit 1
          fi

          (
            cd "$WORKDIR"
            git diff --no-index --binary \
              "template-base/$BASE_ROOT" \
              "template-new/$NEW_ROOT" \
              > "$PATCHFILE" || true
          )

          if [ ! -s "$PATCHFILE" ]; then
            echo "ℹ️  No template diffs; only SHA bump will occur."
          else
            git apply --check -p3 "$PATCHFILE"
            git apply -p3 "$PATCHFILE"
            echo "✅ Applied template changes"
          fi

          echo "Updating template SHA in .cookiecutter.json..."
          jq ".cookiecutter.template_sha = \"${{ steps.new_sha.outputs.sha }}\"" \
            .cookiecutter.json > tmp && mv tmp .cookiecutter.json

          BRANCH="template-update-${{ inputs.repo_branch }}-${{ steps.new_sha.outputs.sha }}"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

          git checkout -b "$BRANCH"
          git config user.name  "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add -A
          git commit -m "chore: merge template updates ${{ steps.old_sha.outputs.sha }} → ${{ steps.new_sha.outputs.sha }}"
          git push origin "$BRANCH"

      - name: Create pull request
        if: env.SHA_CHANGED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          gh pr create \
            --title "chore: merge template updates ${{ steps.old_sha.outputs.sha }} → ${{ steps.new_sha.outputs.sha }}" \
            --body  "Updates cookiecutter.template_sha from ${{ steps.old_sha.outputs.sha }} to ${{ steps.new_sha.outputs.sha }}" \
            --base  '${{ inputs.repo_branch }}' \
            --head  "${{ env.BRANCH }}"

