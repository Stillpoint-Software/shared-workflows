name: Test Report

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]
    branches: [main, develop]          # ← don’t run for misc feature branches

permissions:
  contents: read
  actions: read        # download upstream artifacts
  checks: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      head_branch: ${{ steps.meta.outputs.branch }}
      head_sha:    ${{ steps.meta.outputs.sha }}
    steps:
      - id: meta
        run: |
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          echo "sha=${{   github.event.workflow_run.head_sha    }}" >> "$GITHUB_OUTPUT"
  report:
    needs: discover
    runs-on: ubuntu-latest
    steps:
      # Checkout **the same commit** that the Test job ran on
      - name: Checkout code @ tested SHA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.discover.outputs.head_sha }}

      - name: List work dir before reporter
        run: |
          echo "Artifacts present:"
          find . -maxdepth 3 -type f -name '*.trx' -print

      # 📊 Publish report — let the action pull both artifacts
      - name: Generate combined test report
        uses: dorny/test-reporter@v1
        with:
          # regex matches both test-results-net8.0 and test-results-net9.0
          artifact: /test-results-net[89]\.0/
          name: "Unit Tests (.NET 8 & 9)"
          path: '**/*.trx'
          reporter: dotnet-trx
          fail-on-error: false
          fail-on-empty: false
          list-suites: all
          list-tests: all
          max-annotations: 10
