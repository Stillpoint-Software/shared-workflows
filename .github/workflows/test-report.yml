name: Test Report

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]
    branches: [main, develop]          # ← don’t run for misc feature branches
  workflow_call:
    inputs:
      test_run_id:
        required: false
        type: string
      branch:
        required: false
        type: string
        
permissions:
  contents: read
  actions: read        # download upstream artifacts
  checks: write

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      # Optional: checkout the exact commit the Test job ran on
      - name: Checkout code @ tested SHA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      # 🔍 Debug – list any .trx files that GitHub auto-downloaded
      - name: List workspace before reporter
        run: |
          echo "Listing *.trx we have so far:"
          find . -maxdepth 4 -type f -name '*.trx' -print || true

      - name: ⬇️  Download test artifacts from Test run
        if: ${{ inputs.test_run_id != '' }}      # empty string in auto mode
        uses: actions/download-artifact@v4
        with:
          # ID of the run that produced the artifacts
          run-id:       ${{ inputs.test_run_id }}
      
          # Name of the artifact your Test workflow uploads
          # (adjust if you use something other than "test-results")
          name:         test-results
      
          # Optional—but avoids rate-limit issues on private repos
          github-token: ${{ secrets.GH_TOKEN || github.token }}
      
          # Where to put the files (root is fine)
          path:         .
          
      # 📊 Generate combined report (matches both framework artifacts)
      - name: Publish test report
        uses: dorny/test-reporter@v1
        with:
          # Regex matches test-results-net8.0  and  test-results-net9.0
          artifact: /test-results-net[89]\.0/
          name: "Unit Tests (.NET 8 & 9)"
          path: '**/*.trx'            # look inside both artifact zips
          reporter: dotnet-trx
          fail-on-error: false
          fail-on-empty: false
          list-suites: all
          list-tests: all
          max-annotations: 10
