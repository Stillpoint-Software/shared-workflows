name: Prepare Release & Publish Package

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch or tag to release from"
        type: choice
        options: [ main, master, develop ]
        default: main
        required: true
      increment:
        description: "Version bump"
        type: choice
        options: [ major, minor, patch ]
        default: patch
        required: true

jobs:
  validate_branch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üîç Ensure target branch exists
        run: |
          if ! git ls-remote --exit-code --heads origin "${{ inputs.target_branch }}"; then
            echo "::error::Ref '${{ inputs.target_branch }}' not found."
            exit 1
          fi

  prepare:
    needs: validate_branch
    uses: Stillpoint-Software/shared-workflows/.github/workflows/nbgv_prepare_release.yml@main
    with:
      target_branch: ${{ inputs.target_branch }}
      increment:     ${{ inputs.increment }}
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

  publish:
    needs: prepare
    uses: Stillpoint-Software/shared-workflows/.github/workflows/nbgv_dotnet_pack.yml@main
    with:
      checkout_ref:        ${{ needs.prepare.outputs.release_branch }}
      build_configuration: ${{ inputs.target_branch == 'develop' && 'Develop' || 'Release' }}
      push_after_pack:     true
      force_dev_prerelease: ${{ inputs.target_branch == 'develop' }}
    secrets:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

