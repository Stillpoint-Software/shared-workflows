name: nbgv_prepare_release

on:
  workflow_call:
    inputs:
      target_branch:
        type: string
        description: "Branch / tag to release from"
        default: main
        required: true
		
      increment:
        description: "Which version component to bump: major, minor, or patch" # (patch means 'revision')
        required: true
        type: string

    secrets:
      # The caller repo’s GITHUB_TOKEN is passed automatically; override if desired
      GH_TOKEN:
        description: "Personal-access token if you need extra perms"
        required: false

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    env:
      DOTNET_NOLOGO: true

    steps:
      - name: ⬇️  Checkout full history
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0                # required for commit-height math
          token: ${{ secrets.GH_TOKEN || github.token }}

      - name: 🛠️  Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: 🔧 Restore local tools
        run: dotnet tool restore

      - name: 🗂️  Prepare release branch
        id: prep
        run: |
          # Configure a generic bot identity for the commit
          git config user.name  "release-bot"
          git config user.email "release-bot@users.noreply.github.com"

          # ---- create release branch & bump versions ----
          dotnet nbgv prepare-release --versionIncrement ${{ inputs.increment }}

          # Grab the branch name NBGV just created, e.g. release/v1.2
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: 🚀 Push changes (main + new release branch + tags)
        run: |
          # Prepare-release already committed on both branches and tagged the point release.
          git push --follow-tags origin "${{ inputs.target_branch }}"
          git push --follow-tags origin "${{ steps.prepare.outputs.release_branch }}"
