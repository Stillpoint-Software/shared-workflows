name: nbgv_dotnet_pack

on:
  workflow_call:
    inputs:
      # ğŸ†• caller chooses which commit / branch / tag to build
      checkout_ref:
        description: "Git ref to check out (branch, tag, or SHA)"
        type: string
        default: ${{ github.ref }}

      build_configuration:
        type: string
        default: Release

      push_after_pack:
        type: boolean
        default: false

      force_dev_prerelease:
        type: boolean
        default: false

      nuget_source:
        type: string
        default: https://api.nuget.org/v3/index.json

    secrets:
      NUGET_API_KEY:
        required: false
jobs:
  build-pack:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸  Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}   # caller-supplied branch/tag/SHA
          fetch-depth: 0

      - name: ğŸ› ï¸  Setup .NET
        uses: actions/setup-dotnet@v4
        with: 
          dotnet-version: ${{ inputs.dotnet_version }} 

      - name: ğŸ”§ Restore local tools
        run: dotnet tool restore

      - name: ğŸ“œ Compute version (NBGV)
        run: dotnet nbgv cloud -v q

      - name: ğŸ—ï¸  Build
        run: |
          EXTRA=""
          if [ "${{ inputs.force_dev_prerelease }}" = "true" ]; then
            EXTRA="-p:NBGV_PublicRelease=false"
          fi
          dotnet build -c ${{ inputs.build_configuration }} $EXTRA

      - name: ğŸ“¦ Pack
        run: |
          EXTRA=""
          if [ "${{ inputs.force_dev_prerelease }}" = "true" ]; then
            EXTRA="-p:NBGV_PublicRelease=false"
          fi
          dotnet pack -c ${{ inputs.build_configuration }} -o output $EXTRA

      - name: ğŸš€ Push to NuGet
        if: inputs.push_after_pack == true
        run: |
          dotnet nuget push "output/*.nupkg" \
            --source "${{ inputs.nuget_source }}" \
            --api-key "${{ secrets.NUGET_API_KEY }}" \
            --skip-duplicate
