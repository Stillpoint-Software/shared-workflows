name: NDGV Pack & Publish Package

on:
  workflow_call:
    inputs:
      checkout_ref:
        description: "Branch/ref to check out and pack"
        type: string
        required: true
      build_configuration:
        description: "Build configuration (e.g. Release, Develop)"
        type: string
        required: true
      push_after_pack:
        description: "Whether to push the resulting .nupkg"
        type: boolean
        required: true
      force_dev_prerelease:
        description: "Whether to include dev prerelease symbols"
        type: boolean
        required: true
    secrets:
      NUGET_API_KEY:
        description: "API key for pushing to NuGet.org"
        required: true

jobs:
  pack:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: üîÑ Restore
        run: dotnet restore

      - name: üèóÔ∏è Build
        run: dotnet build -c ${{ inputs.build_configuration }} --no-restore

      - name: üì¶ Pack
        run: |
          # symbols/source only when caller asks
          EXTRA_FLAGS=""
          if [ "${{ inputs.force_dev_prerelease }}" = "true" ]; then
            EXTRA_FLAGS="--include-symbols --include-source"
          fi

          # PublicRelease strips commit-height *only* on Release builds
          PUBLIC_RELEASE_FLAG=""
          if [ "${{ inputs.build_configuration }}" = "Release" ]; then
            PUBLIC_RELEASE_FLAG="-p:PublicRelease=true"
          fi

          dotnet pack -c ${{ inputs.build_configuration }} \
                      --no-build --no-restore \
                      --output ./artifacts \
                      $PUBLIC_RELEASE_FLAG \
                      $EXTRA_FLAGS

      - name: üöÄ Publish to NuGet
        if: ${{ inputs.push_after_pack }}
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          dotnet nuget push "./artifacts/*.nupkg" \
            --api-key "$NUGET_API_KEY" \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
