name: Test

on:
  workflow_call:
    inputs:
      dotnet_version:
        description: "The .NET SDK version to use"
        required: false
        default: "9.0.x"
        type: string
      solution_name:
        description: "Solution file to build and test"
        required: true
        type: string
    secrets:
      GH_TOKEN:
        description: "GitHub token with write permissions"
        required: false
 
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet_version: [ '9.0.x', '8.0.x' ]

    env:
      DOTNET_VERSION: ${{ inputs.dotnet_version }}
      SOLUTION_NAME: ${{ inputs.solution_name }}
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

    steps:
      - name: Set Build Configuration (Release if main)
        run: |
          if [ "${{ env.BRANCH_NAME }}" = "main" ]; then
            echo "BUILD_CONFIGURATION=Release" >> $GITHUB_ENV
          else
            echo "BUILD_CONFIGURATION=Debug" >> $GITHUB_ENV
          fi

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || github.token }}
          fetch-depth: 0  

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore Dependencies
        run: dotnet restore ${{ env.SOLUTION_NAME }}

      - name: Build
        run: dotnet build --no-restore --configuration ${{ env.BUILD_CONFIGURATION }} ${{ env.SOLUTION_NAME }}

      - name: Run Tests
        run: |
          mkdir -p TestResults
          found=false
          for proj in $(find . -name "*.Tests.csproj"); do
            found=true
            echo "Inspecting $proj for target frameworks..."
      
            # Get target frameworks from the csproj
            frameworks=$(grep -oPm1 "(?<=<TargetFrameworks>)[^<]+" "$proj" || true)
            if [ -z "$frameworks" ]; then
              frameworks=$(grep -oPm1 "(?<=<TargetFramework>)[^<]+" "$proj" || true)
            fi
      
            if [ -z "$frameworks" ]; then
              echo "⚠️ No TargetFramework found in $proj, skipping..."
              continue
            fi
      
            # Split on ';' in case of multi-targeting
            for fw in $(echo $frameworks | tr ';' ' '); do
              echo "Running tests for $proj ($fw)"
              dotnet test "$proj" \
                --no-build \
                --configuration ${{ env.BUILD_CONFIGURATION }} \
                --framework $fw \
                --logger "trx;LogFileName=$(basename $proj)-$fw.trx" \
                --results-directory ./TestResults
            done
          done

    if [ "$found" = false ]; then
      echo "⚠️ No test projects (*.Tests.csproj) were found in this repository."
      exit 1
    fi

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: test-results
          path: ./TestResults/**/*.trx
